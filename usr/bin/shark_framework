#!/bin/bash

LOG="logger -t Shark [*]"
LOG_ERR="logger -t Shark -p 3 [!]"

MODE="OFF"
SWITCH_POSITION=$(/usr/bin/SWITCH)


function configure_network() {
    cp /usr/lib/config/${SWITCH_POSITION}/network /etc/config/network
    /etc/init.d/network restart
}

function start_http() {
    /etc/init.d/uhttpd start
}

function stop_http() {
    /etc/init.d/uhttpd stop
}

function start_ssh() {
    /etc/init.d/sshd start
}

function stop_ssh() {
    /etc/init.d/sshd stop
}

function enter_attack_mode() {
    $LOG "Entering ATTACK mode"
    MODE="ATTACK"
    /usr/bin/LED OFF

    configure_network
    stop_http
    stop_ssh

    execute_payload

    enter_idle_mode
}

function enter_arming_mode() {
    $LOG "Entering ARMING mode"
    MODE="ARMING"
    /usr/bin/LED OFF

    configure_network
    start_http
    start_ssh

    enter_idle_mode
}

function enter_off_mode() {
    $LOG "Entering OFF mode"
    MODE="OFF"
    /usr/bin/LED OFF

    stop_http
    stop_ssh

    enter_idle_mode
}

function enter_idle_mode() {
    $LOG "Entering IDLE mode"
    while true
    do
        if [[ $MODE = "ARMING" ]] || [[ $MODE = "OFF" ]]; then
            BATTERY_STATE=$(/usr/bin/BATTERY)
            case $BATTERY_STATE in
                "charging")
                    /usr/bin/LED B SLOW
                    ;;
                "full")
                    /usr/bin/LED B
                    ;;
                *)
                    /usr/bin/LED Y SLOW
                    if [[ $MODE = "OFF" ]]; then
                        sleep 2 && halt
                    fi
                    ;;
            esac
        fi

        SWITCH_POSITION=$(/usr/bin/SWITCH)
        case $SWITCH_POSITION in
            "switch3")
                if [[ $MODE != "ATTACK" ]]; then
                    enter_attack_mode
                fi
                ;;
            "switch2")
                if [[ $MODE != "ARMING" ]]; then
                    enter_arming_mode
                fi
                ;;
            *)
                if [[ $MODE != "OFF" ]]; then
                    enter_off_mode
                fi
                ;;
        esac
        sleep 1
    done
}

function execute_payload() {
    $LOG "Executing PAYLOAD"

    if [ ! -d /root/loot ]; then
        mkdir -p /root/loot;
    fi

    payload_path="/root/payload"
    payload=$(ls $payload_path/payload* 2>/dev/null | tail -n1)

    case $(basename $payload) in
        "payload.py")
            echo "python $payload &> /dev/null" | at now
            ;;
        "payload.php")
            echo "php-cli $payload &> /dev/null" | at now
            ;;
        "payload" | "payload.sh" | "payload.txt")
            sed -i 's/\r//g' $payload
            chmod +x $payload
            echo "bash -c '$payload'" | at now
            ;;
        *)
            /usr/bin/LED FAIL
            ;;
    esac
}

function run() {
    case $SWITCH_POSITION in
        "switch3")
            enter_attack_mode
            ;;
        "switch2")
            enter_arming_mode
            ;;
        *)
            enter_off_mode
            ;;
    esac
}


# Start framework after a short wait
sleep 2
run &> /dev/null &
